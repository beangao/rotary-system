generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ========================================
// クラブ（マルチテナント）
// ========================================
model Club {
  id          String   @id @default(uuid())
  name        String   @db.VarChar(100)
  nameKana    String?  @map("name_kana") @db.VarChar(100)
  description String?  @db.Text
  logoUrl     String?  @map("logo_url") @db.VarChar(500)
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  members       Member[]
  events        Event[]
  notifications Notification[]
  clubAdmins    ClubAdmin[]

  @@map("clubs")
}

// ========================================
// スーパー管理者（サービス運営）
// ========================================
model SuperAdmin {
  id        String   @id @default(uuid())
  email     String   @unique @db.VarChar(255)
  password  String   @db.VarChar(255)
  name      String   @db.VarChar(100)
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("super_admins")
}

// ========================================
// クラブ管理者（事務局）
// ========================================
model ClubAdmin {
  id        String   @id @default(uuid())
  clubId    String   @map("club_id")
  email     String   @db.VarChar(255)
  password  String   @db.VarChar(255)
  name      String   @db.VarChar(100)
  role      String   @default("admin") @db.VarChar(50) // admin, editor, viewer
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  club Club @relation(fields: [clubId], references: [id])

  @@unique([clubId, email])
  @@map("club_admins")
}

// ========================================
// 会員
// ========================================
model Member {
  id                     String    @id @default(uuid())
  clubId                 String    @map("club_id")

  // 認証情報
  email                  String    @db.VarChar(255)
  password               String?   @db.VarChar(255)
  verificationCode       String?   @map("verification_code") @db.VarChar(6)
  verificationCodeExpiry DateTime? @map("verification_code_expiry")

  // 基本情報（事務局管理 - ReadOnly）
  memberNumber           String?   @map("member_number") @db.VarChar(50)
  lastName               String    @map("last_name") @db.VarChar(50)
  firstName              String    @map("first_name") @db.VarChar(50)
  lastNameKana           String?   @map("last_name_kana") @db.VarChar(50)
  firstNameKana          String?   @map("first_name_kana") @db.VarChar(50)
  gender                 String?   @db.VarChar(10) // male, female, other
  birthDate              DateTime? @map("birth_date") @db.Date
  position               String?   @db.VarChar(100) // 役職
  joinDate               DateTime? @map("join_date") @db.Date

  // プロフィール情報（会員編集可能 - Writable）
  industryClassification String?   @map("industry_classification") @db.VarChar(100)
  companyName            String?   @map("company_name") @db.VarChar(200)
  department             String?   @db.VarChar(100)
  phoneNumber            String?   @map("phone_number") @db.VarChar(20)
  avatarUrl              String?   @map("avatar_url") @db.VarChar(500)
  hometown               String?   @db.VarChar(100) // 出身地
  school                 String?   @db.VarChar(200) // 出身校
  hobbies                String?   @db.Text // 趣味・特技
  introduction           String?   @db.Text // 自己紹介

  // プライバシー設定
  privacySettings        String?   @map("privacy_settings") @db.Text // JSON

  // ステータス
  status                 String    @default("invited") @db.VarChar(20) // invited, active, inactive, withdrawn
  profileCompleted       Boolean   @default(false) @map("profile_completed")
  lastLoginAt            DateTime? @map("last_login_at")

  createdAt              DateTime  @default(now()) @map("created_at")
  updatedAt              DateTime  @updatedAt @map("updated_at")

  // Relations
  club        Club         @relation(fields: [clubId], references: [id])
  attendances Attendance[]

  @@unique([clubId, email])
  @@unique([clubId, memberNumber])
  @@index([clubId, status])
  @@index([clubId, lastName, firstName])
  @@map("members")
}

// ========================================
// イベント・例会
// ========================================
model Event {
  id               String    @id @default(uuid())
  clubId           String    @map("club_id")

  title            String    @db.VarChar(200)
  description      String?   @db.Text
  eventType        String    @map("event_type") @db.VarChar(50) // meeting, service, social, district, other

  startAt          DateTime  @map("start_at")
  endAt            DateTime? @map("end_at")

  venue            String?   @db.VarChar(200)
  venueAddress     String?   @map("venue_address") @db.Text
  onlineUrl        String?   @map("online_url") @db.VarChar(500)

  responseDeadline DateTime? @map("response_deadline")

  // ステータス管理
  status           String    @default("draft") @db.VarChar(20) // draft, published, closed, cancelled, postponed
  isPublished      Boolean   @default(false) @map("is_published")

  // 延期対応
  originalDate     DateTime? @map("original_date")
  postponedDate    DateTime? @map("postponed_date")

  // 添付ファイル
  attachmentUrl    String?   @map("attachment_url") @db.VarChar(500)
  attachmentName   String?   @map("attachment_name") @db.VarChar(200)

  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  // Relations
  club        Club         @relation(fields: [clubId], references: [id])
  attendances Attendance[]

  @@index([clubId, startAt])
  @@index([clubId, status])
  @@map("events")
}

// ========================================
// 出欠
// ========================================
model Attendance {
  id        String   @id @default(uuid())
  eventId   String   @map("event_id")
  memberId  String   @map("member_id")

  status    String   @db.VarChar(20) // attending, absent, undecided
  comment   String?  @db.Text

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  event  Event  @relation(fields: [eventId], references: [id])
  member Member @relation(fields: [memberId], references: [id])

  @@unique([eventId, memberId])
  @@map("attendances")
}

// ========================================
// お知らせ
// ========================================
model Notification {
  id          String    @id @default(uuid())
  clubId      String    @map("club_id")

  title       String    @db.VarChar(200)
  content     String    @db.Text
  category    String?   @db.VarChar(50) // general, important, event, etc.

  isPublished Boolean   @default(false) @map("is_published")
  publishedAt DateTime? @map("published_at")

  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // Relations
  club Club @relation(fields: [clubId], references: [id])

  @@index([clubId, isPublished, publishedAt])
  @@map("notifications")
}
